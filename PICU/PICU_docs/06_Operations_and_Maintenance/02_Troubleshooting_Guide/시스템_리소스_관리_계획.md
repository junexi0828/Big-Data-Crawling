# 시스템 리소스 관리 계획

**작성일**: 2025-12-07
**업데이트**: 2025-12-07
**상태**: ✅ 리소스 최적화 완료

---

## 📋 현황

### 현재 상황
- **모니터링 대상**: 실제 로컬 노트북 리소스 (가상환경 아님)
- **과부하 상태**: CPU 97%, RAM 80-85%
- **실행 중인 프로세스**: 15개+ (Spider, Kafka Consumer, HDFS, Backend, Frontend 등)

### 리소스 측정 방식
- `psutil` 라이브러리 사용
- 실제 시스템 리소스 측정 (가상환경과 무관)
- `psutil.cpu_percent()`, `psutil.virtual_memory()` 등

---

## 🎯 관리 전략

### 1. 모니터링 최적화

#### 업데이트 주기 조정
- **현재**: 2초마다 업데이트
- **권장**: 5-10초로 조정
- **효과**: CPU 사용량 50% 감소 예상

#### 측정 방식 개선
```python
# 현재: interval=None (논블로킹, 부정확할 수 있음)
cpu_percent = psutil.cpu_percent(interval=None)

# 개선: 캐싱 + 배치 업데이트
# - 5초마다 한 번만 실제 측정
# - 나머지 시간은 캐시된 값 사용
```

### 2. 프로세스 관리

#### 자동 스케줄링
- **Spider**: 동시 실행 개수 제한 (최대 2-3개)
- **Kafka Consumer**: 단일 인스턴스만 유지
- **불필요한 프로세스**: 자동 정리

#### 리소스 우선순위
1. **필수**: Backend, Frontend, Kafka Consumer
2. **선택적**: Spider (스케줄 기반 실행)
3. **수동**: MapReduce (필요 시만)

### 3. 리소스 임계값 설정

#### 경고 기준
- CPU > 80%: 경고 표시
- CPU > 90%: 자동 조치 (불필요한 프로세스 중지)
- RAM > 85%: 경고 표시
- RAM > 90%: 자동 조치

#### 자동 조치
- 낮은 우선순위 프로세스 자동 중지
- 사용자에게 알림 표시
- 로그 기록

### 4. 모니터링 주기 최적화

#### 현재 구조
```python
# app.py
stats_timer = QTimer()
stats_timer.timeout.connect(self._update_all_stats)
stats_timer.start(2000)  # 2초마다
```

#### 개선안
```python
# 리소스별 다른 주기
resource_timer = QTimer()  # 5초 (시스템 자원)
pipeline_timer = QTimer()  # 3초 (파이프라인 상태)
process_timer = QTimer()   # 2초 (프로세스 상태)
```

---

## 🔧 구현 완료

### Phase 1: 모니터링 최적화 ✅
- [x] 업데이트 주기 2초 → 5초로 변경 (`gui/core/timing_config.py:30,36`)
- [x] 리소스 측정 캐싱 추가 (5초 TTL) (`gui/modules/managers/system_monitor.py:46-48,75-81`)
- [x] Kafka 모듈 캐싱 추가 (5초 TTL) (`gui/modules/kafka_module.py:37-42`)

**변경 파일:**
- `gui/core/timing_config.py`: 기본값 3초 → 5초
- `gui/app.py`: 타이머 기본값 업데이트 (3곳)
- `gui/ui/config_tab.py`: 설정 저장 로직 업데이트
- `gui/modules/managers/system_monitor.py`: 캐싱 메커니즘 구현
- `gui/modules/kafka_module.py`: get_stats/get_consumer_groups 캐싱

### Phase 2: 자동 관리 ✅
- [x] 리소스 임계값 설정 (CPU > 97% AND RAM > 98%)
- [x] 자동 프로세스 중지 로직 (`gui/app.py:1557-1615`)
- [x] 사용자 알림 시스템 (로그 + 상태바)

**구현 내용:**
- `SystemMonitor.is_extremely_critical()`: 극한 상황 감지
- `_auto_stop_low_priority_processes()`: 자동 중지 로직
- 중지 우선순위: Frontend > Spider (2개 이상 시 1개 남김)
- 5분 간격 제한 (과도한 중지 방지)

### Phase 3: 스케줄링 (보류)
- Spider 동시 실행 제한: 자동 중지 로직으로 대체
- 리소스 기반 스케줄링: CPU/RAM 임계값 기반 자동 조치 구현
- 우선순위 기반 프로세스 관리: 완료 (Frontend > Spider)

---

## 📊 최적화 효과

### 모니터링 오버헤드 감소
| 항목 | 이전 | 현재 | 개선율 |
|------|------|------|--------|
| 통계 업데이트 주기 | 2-3초 | 5초 | ~50% 감소 |
| 리소스 측정 호출 | 매번 | 캐시 (5초 TTL) | ~80% 감소 |
| Kafka 조회 호출 | 매번 | 캐시 (5초 TTL) | ~80% 감소 |

### 예상 CPU 사용량 감소
- **모니터링 오버헤드**: 약 40-50% 감소
- **Kafka 모듈 부하**: 약 60-70% 감소 (캐싱 + 브로커 체크)
- **전체 CPU 사용량**: 97% → 예상 70-80% 수준

### 자동 조치 효과
- **극한 상황 대응**: CPU > 97% AND RAM > 98% 시 자동 프로세스 중지
- **정보 손실 최소화**: Frontend(UI만) → Spider(일부만) 순으로 중지
- **핵심 파이프라인 보호**: Backend, HDFS, Kafka는 절대 중지 안 함

---

## ⚠️ 주의사항 및 사용 가이드

### 1. 가상환경 vs 실제 리소스
- 가상환경은 패키지 격리만 제공
- 실제 CPU/RAM은 호스트 시스템 사용
- GUI 표시는 실제 노트북 리소스

### 2. 자동 중지 동작 방식
- **트리거 조건**: CPU > 97% **AND** RAM > 98% (동시 만족)
- **중지 간격**: 5분마다 최대 1회 (과도한 중지 방지)
- **중지 대상**:
  1. Frontend (우선) - 정보 손실 없음
  2. Spider (2개 이상 실행 시 1개 남김) - 데이터 수집 계속됨
- **중지 안 함**: Backend, HDFS, Kafka (핵심 파이프라인)

### 3. 수동 조치가 필요한 경우
- 자동 중지 후에도 리소스 부족이 계속될 경우:
  1. 실행 중인 Spider 추가 중지
  2. 다른 애플리케이션 종료
  3. 시스템 재시작 고려

### 4. 설정 조정
- 통계 업데이트 주기: GUI 설정 탭에서 조정 가능 (기본 5초)
- 리소스 임계값: `system_monitor.py:195`에서 조정 가능
- 자동 중지 간격: `app.py:1569`에서 조정 가능 (기본 300초)

---

## 📝 참고 파일

### 핵심 구현 파일
- **SystemMonitor**: `gui/modules/managers/system_monitor.py`
  - `get_system_stats()`: 리소스 측정 + 캐싱
  - `is_extremely_critical()`: 극한 상황 감지 (Line 173-195)

- **GUI 메인**: `gui/app.py`
  - `stats_timer`: 통계 업데이트 타이머 (Line 141-144)
  - `_update_resource_display()`: 리소스 표시 업데이트 (Line 1499-1555)
  - `_auto_stop_low_priority_processes()`: 자동 중지 로직 (Line 1557-1615)

- **Kafka 모듈**: `gui/modules/kafka_module.py`
  - 캐싱 변수: Line 37-42
  - `get_stats()` 캐싱: Line 218-263
  - `get_consumer_groups()` 캐싱: Line 265-380

- **설정 파일**: `gui/core/timing_config.py`
  - 업데이트 주기 기본값: Line 30, 36

### 로그 확인
- 자동 중지 알림: `🚨 극도로 높은 리소스 사용` 로그 검색
- 리소스 경고: `⚠️ 자원 부족` 로그 검색

